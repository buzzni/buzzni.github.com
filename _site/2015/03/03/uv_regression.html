<!DOCTYPE html>

<html>
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="prefetch" href="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js">
    <meta name="application-name" content="Buzzni Eng">
    <meta name="msapplication-tooltip" content="The engineering blog of the Buzzni">
    <meta name="apple-mobile-web-app-title" content="Buzzni Eng">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="HandheldFriendly" content="True">
    <meta name="format-detection" content="telephone=no">
    <meta http-equiv="cleartype" content="on">
    <meta http-equiv="imagetoolbar" content="false">

    <link rel="stylesheet" href="/css/main.css">

    <meta property="og:site_name" content="Buzzni Eng">
    <meta property="og:type" content="website">

    <title>Machine Learning 으로 오늘의 UV 맞추기</title>
    <meta property="og:title" content="Machine Learning 으로 오늘의 UV 맞추기">

    <meta name="description" content="Regression 모델을 이용하여 바탕으로 오늘의 UV를 예측 해보기">
    <meta name="og:description" content="Regression 모델을 이용하여 바탕으로 오늘의 UV를 예측 해보기">
    <meta name="keywords" content="Buzzni programming language web engineering tech software blog">
    <meta property="og:tag" content="Buzzni programming language web engineering tech software blog">

    <link rel="canonical" href="http://engineering.buzzni.com/2015/03/03/uv_regression.html">
  <meta property="og:image" content="http://i2.wp.com/elenacuoco.altervista.org/blog/wp-content/uploads/2014/09/scikit.png" />
</head>


    <body>

        <nav>

    <div class="container"> 

        <ul>
            <li class="members">
                <a href="/about" title="버즈니 소개" >소개</a>
            </li>
            
            <li class="blog">
                <a href="/" title="기술 블로그" class="active">기술 블로그</a>
            </li>

            <li class="jobs">
                <a href="/jobs" title="채용정보" >채용정보</a>
            </li>

            <li class="github">
                <a href="https://github.com/buzzni/buzzni.github.com" title="Github">GitHub</a>
            </li>
        </ul>

    </div>

</nav>


        <div id="content" class="page-content">
            <div class="wrapper">
                <div class="post-header">
    <div class="layer"></div>
    <div class="bg" style="background: url(http://i2.wp.com/elenacuoco.altervista.org/blog/wp-content/uploads/2014/09/scikit.png) center center no-repeat; background-size: cover;"></div>
    <div class="wrapper">
        <div class="post-title">
            <h1>Machine Learning 으로 오늘의 UV 맞추기</h1>
            <div class="post-excerpt">Regression 모델을 이용하여 바탕으로 오늘의 UV를 예측 해보기</div>
        </div>
    </div>
</div>

<div class="post-meta">
    <div class="container">
        <div class="portrait"><img src="/images/justin@buzzni.com.png" /></div>
        <div class="author-name"><a href="mailto:justin@buzzni.com">Justin</a></div>
        <div class="post-date">2015년 03월 03일</div>
        <div>
            <ul class="tags">
                
                    <li>#machine</li>
                
                    <li>#learning,</li>
                
                    <li>#regression,</li>
                
                    <li>#server,</li>
                
                    <li>#mining</li>
                
            </ul>
        </div>
    </div>
</div>


<div class="post">
    <div class="container">
        <article class="markdown-body">
            <h1 id="section">시작하며</h1>

<p>안녕하세요? 버즈니에서 검색, 데이터 마이닝 부분을 맡고 있는 저스틴 (Justin) 입니다.</p>

<p>저는 Search Engine 과 Machine Learning 분야를 연구하고 이를 활용한 응용 서비스를 만드는 것을 굉장히 좋아합니다.</p>

<p>2007년도에 버즈니를 창업하고 나서 지금까지 꾸준히 관련 기술을 연구하고 실제 서비스에 많이 적용해 왔습니다.</p>

<p>이 분야를 정말 좋아한 나머지 업무가 끝나고 나서도 취미로 새로운 기술들을 익히거나 새로운 응용들을 만들어 보기도 합니다.</p>

<p>오늘 소개해드릴 내용은 그런 취미 활동중 하나로,</p>

<p>업무를 하다가 반복적으로 생각 했던 일을 Machine Learning 을 실제로 사용하여 해결한 사례입니다.</p>

<p>이 주제는 현재 버즈니 개발팀에서 진행하는 Data Mining Study 의 첫번째 실습 예제입니다.</p>

<h1 id="section-1">개요</h1>

<p>저희는 사무실 내에서도 큰 TV 에 현재 접속자 수 등 중요 통계를 항상 띄워 놓을 정도로, 통계를 아주 중요하게 생각하고 있습니다.</p>

<p>그래서 매 시간마다 현재까지 접속자 수(UV)를 기준으로 오늘 UV 는 대략 얼마 정도가 될 것 같다고 머리속으로 예측을 해왔습니다.</p>

<p>심지어 단순히 2만 곱하면 거의 그날의 UV 가 되는 시간대까지 찾아내기도 했습니다.</p>

<p>그렇게 매번 수치를 보고 오늘의 트래픽을 머리속으로 계산을 하다가, 문득 이런 생각이 들었습니다.</p>

<p>사람이 과거 데이터 기록을 이용하여 오늘의 트래픽을 예측하듯이 Machine Learning 을 활용하면</p>

<p>오늘의 UV 를 더 정확하게 예측할 수 있지 않을까 하는 생각이 들었습니다.</p>

<p>이전에 공부를 했던 데이터 마이닝 모델들을 쭉 살펴봤더니 그동안 공부만 하고 실제 업무에는 활용을 잘 안했던</p>

<p>Regression 모델을 이용하면 딱이겠다는 생각이 들었습니다.</p>

<h1 id="section-2">준비물</h1>

<p>잘 아시는 분들도 있겠지만, 처음 접하는 분들을 위해서 준비물에 대해서 좀 더 설명을 드리겠습니다.</p>

<ol>
  <li><a href="http://scikit-learn.org">Scikit-Learn</a> : Python 에서 Machine Learning 을 하는 대표적인 Library 입니다.</li>
  <li><a href="http://ipython.org">IPython</a> : IPython Notebook 이란 것을 주로 사용합니다. 해외에서 하는 많은 컨퍼런스를 보면 IPython 으로 튜토리얼을 진행하는 것을 상당히 많이 볼 수 있습니다. pycon에 보면 IPython 을 안 쓰는 튜토리얼을 찾아 보기 힘들정도로 많이 사용합니다. web browser 에서 interactive 하게 다양한 파라미터로 실험을 하고 그래프를 그리기가 아주 편하게 되어 있어서 science 용으로 딱 좋습니다.</li>
</ol>

<h1 id="section-3">데이터</h1>

<p>필요한 데이터는 최근 한달간 <code>각 시간대별 UV</code> 및 <code>각 일자별 UV</code> 입니다.</p>

<p>버즈니에서는 로그 데이터를 EFK(ElasticSearch, Fluentd, Kibana)를 사용하여 분석하고 관리하고 있습니다.</p>

<p>이 데이터를 추출할때 Kibana 를 통해서 ElasticSearch 에 어떤 Query 를 만들어야 시간당 UV, 일간 UV 를 가져오는지 알 수 있습니다. 
<img src="https://dl-web.dropbox.com/get/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202015-03-04%2021.32.47.png?_subject_uid=22018269&amp;w=AABPmuA57gtVoowTWNOYF87nInusxEGnm94k_oDuX7dofQ" alt="img" /></p>

<h1 id="ipython-">IPython 노트북</h1>

<h2 id="section-4">목표</h2>

<ul>
  <li>현재 시간까지의 시간대별 UV 합을 입력하면, 오늘 하루의 UV 예측치를 알려주는 시스템을 만들어봅니다.</li>
  <li>각 시간대별로 모델을 만든다. 이때 Linear Regression 모델을 활용합니다.</li>
</ul>

<h2 id="import">필요한 모듈 import</h2>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># coding: utf-8</span>

<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">dateutil</span> <span class="kn">import</span> <span class="n">parser</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span></code></pre></div>

<h2 id="section-5">학습데이터 준비</h2>

<ul>
  <li>X train 데이터 : 최근 한달 동안 각 시간대별 누적 UV , 예를 들어 <code>3시</code>라고 하면, 1시부터 3시까지 쌓인 UV 수의 합</li>
  <li>Y train 데이터 : 최근 한달 동안 각 일자별 하루 UV 수</li>
</ul>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">index_str</span><span class="o">=</span><span class="s">&quot;_all&quot;</span>
<span class="n">_LOG_ES_URL</span> <span class="o">=</span> <span class="s">&quot;http://localhost:9200/&quot;</span></code></pre></div>

<ul>
  <li>아래는 Log 데이터가 저장된 Elastic Search 에 요청할 Query 입니다.</li>
  <li>Query를 어떻게 요청해야 할지는 Kibana 를 통해서 알아냈습니다.</li>
</ul>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">es_daily_query</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s">&quot;size&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">&quot;filtered&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&quot;query_string&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s">&quot;query&quot;</span><span class="p">:</span> <span class="s">&quot;ps:nginx&quot;</span><span class="p">,</span>
          <span class="s">&quot;analyze_wildcard&quot;</span><span class="p">:</span> <span class="bp">True</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="s">&quot;filter&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&quot;bool&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s">&quot;must&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="s">&quot;range&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&quot;@timestamp&quot;</span><span class="p">:</span> <span class="p">{</span>
                  <span class="s">&quot;gte&quot;</span><span class="p">:</span> <span class="mi">1422806671815</span><span class="p">,</span>
                  <span class="s">&quot;lte&quot;</span><span class="p">:</span> <span class="mi">1425398671815</span>
                <span class="p">}</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">],</span>
          <span class="s">&quot;must_not&quot;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="s">&quot;aggs&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">&quot;2&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s">&quot;date_histogram&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&quot;field&quot;</span><span class="p">:</span> <span class="s">&quot;@timestamp&quot;</span><span class="p">,</span>
        <span class="s">&quot;interval&quot;</span><span class="p">:</span> <span class="s">&quot;1d&quot;</span><span class="p">,</span>
        <span class="s">&quot;pre_zone&quot;</span><span class="p">:</span> <span class="s">&quot;+09:00&quot;</span><span class="p">,</span>
        <span class="s">&quot;pre_zone_adjust_large_interval&quot;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="s">&quot;min_doc_count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s">&quot;extended_bounds&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s">&quot;min&quot;</span><span class="p">:</span> <span class="mi">1422806671814</span><span class="p">,</span>
          <span class="s">&quot;max&quot;</span><span class="p">:</span> <span class="mi">1425398671814</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="s">&quot;aggs&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&quot;1&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s">&quot;cardinality&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&quot;field&quot;</span><span class="p">:</span> <span class="s">&quot;xid&quot;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">es_daily_query</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">es_daily_query</span><span class="p">)</span>
<span class="n">url</span> <span class="o">=</span> <span class="n">_LOG_ES_URL</span> <span class="o">+</span> <span class="n">index_str</span> <span class="o">+</span> <span class="s">&#39;/_search?pretty&#39;</span>
<span class="n">daily_result</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">es_daily_query</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span></code></pre></div>

<ul>
  <li>각 일별 UV 데이터를 daily_uv_dict 변수에 저장합니다.</li>
</ul>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">daily_uv_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">daily_result</span><span class="p">[</span><span class="s">u&#39;aggregations&#39;</span><span class="p">][</span><span class="s">&#39;2&#39;</span><span class="p">][</span><span class="s">u&#39;buckets&#39;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
    <span class="n">date_str</span> <span class="o">=</span> <span class="n">each</span><span class="p">[</span><span class="s">&#39;key_as_string&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;T&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">daily_uv_dict</span><span class="p">[</span><span class="n">date_str</span><span class="p">]</span> <span class="o">=</span> <span class="n">each</span><span class="p">[</span><span class="s">u&#39;1&#39;</span><span class="p">][</span><span class="s">u&#39;value&#39;</span><span class="p">]</span></code></pre></div>

<ul>
  <li>각 시간대별 UV 수를 요청하는 Query 입니다.</li>
</ul>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">es_hour_query</span> <span class="o">=</span><span class="p">{</span>
  <span class="s">&quot;size&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">&quot;filtered&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&quot;query_string&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s">&quot;query&quot;</span><span class="p">:</span> <span class="s">&quot;ps:nginx&quot;</span><span class="p">,</span>
          <span class="s">&quot;analyze_wildcard&quot;</span><span class="p">:</span> <span class="bp">True</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="s">&quot;filter&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&quot;bool&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s">&quot;must&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="s">&quot;range&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&quot;@timestamp&quot;</span><span class="p">:</span> <span class="p">{</span>
                  <span class="s">&quot;gte&quot;</span><span class="p">:</span> <span class="mi">1422806539236</span><span class="p">,</span>
                  <span class="s">&quot;lte&quot;</span><span class="p">:</span> <span class="mi">1425398539236</span>
                <span class="p">}</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">],</span>
          <span class="s">&quot;must_not&quot;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="s">&quot;aggs&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">&quot;2&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s">&quot;date_histogram&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&quot;field&quot;</span><span class="p">:</span> <span class="s">&quot;@timestamp&quot;</span><span class="p">,</span>
        <span class="s">&quot;interval&quot;</span><span class="p">:</span> <span class="s">&quot;1h&quot;</span><span class="p">,</span>
        <span class="s">&quot;pre_zone&quot;</span><span class="p">:</span> <span class="s">&quot;+09:00&quot;</span><span class="p">,</span>
        <span class="s">&quot;pre_zone_adjust_large_interval&quot;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="s">&quot;min_doc_count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s">&quot;extended_bounds&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s">&quot;min&quot;</span><span class="p">:</span> <span class="mi">1422806539235</span><span class="p">,</span>
          <span class="s">&quot;max&quot;</span><span class="p">:</span> <span class="mi">1425398539235</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="s">&quot;aggs&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&quot;1&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s">&quot;cardinality&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&quot;field&quot;</span><span class="p">:</span> <span class="s">&quot;xid&quot;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">es_hour_query</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">es_hour_query</span><span class="p">)</span>

<span class="n">url</span> <span class="o">=</span> <span class="n">_LOG_ES_URL</span> <span class="o">+</span> <span class="n">index_str</span> <span class="o">+</span> <span class="s">&#39;/_search?pretty&#39;</span>
<span class="n">hour_uv_result</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">es_hour_query</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

<span class="n">hour_uv_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">hour</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">24</span><span class="p">):</span>
    <span class="n">hour_uv_dict</span><span class="p">[</span><span class="n">hour</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">y_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">hour_model_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">hour_model_dict2</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">TRAIN_DATE</span> <span class="o">=</span> <span class="s">&#39;2015-02-20&#39;</span></code></pre></div>

<h2 id="section-6">모델 학습</h2>

<ul>
  <li>각 시간대별로 모델을 별도로 만듭니다.</li>
  <li>1,2 두가지 모델을 만드는데, 1은 현재시간까지의 UV 합 데이터만을 이용해서 학습을 하고</li>
  <li>2 모델은 현재 시각의 UV 와, 현재 시간까지의 UV 합 2가지 데이터를 이용해서 학습합니다.</li>
  <li>2015-02-20 이전 날짜의 데이터를 Train 데이터로 사용하고, 이 이후의 데이터를 Test 데이터로 사용합니다.</li>
</ul>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">for</span> <span class="n">hour</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">24</span><span class="p">):</span>
    <span class="n">x_list1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">y_list1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">x_list2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">y_list2</span> <span class="o">=</span> <span class="p">[]</span>    
    <span class="n">key_count_sum</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">pre_day</span> <span class="o">=</span> <span class="mi">0</span> 
    <span class="c"># 현재 시간대 hour 에 대해서 각 날짜별로 해당 시간까지의 UV 합을 구한다. </span>
    <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">hour_uv_result</span><span class="p">[</span><span class="s">u&#39;aggregations&#39;</span><span class="p">][</span><span class="s">&#39;2&#39;</span><span class="p">][</span><span class="s">u&#39;buckets&#39;</span><span class="p">]:</span>
        <span class="n">parse_date</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">each</span><span class="p">[</span><span class="s">u&#39;key_as_string&#39;</span><span class="p">])</span>
        <span class="n">day</span> <span class="o">=</span> <span class="n">parse_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s">&quot;</span><span class="p">)</span>   
        <span class="n">hour_uv</span> <span class="o">=</span> <span class="n">each</span><span class="p">[</span><span class="s">&#39;1&#39;</span><span class="p">][</span><span class="s">&#39;value&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">daily_uv_dict</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">day</span><span class="p">):</span>
            <span class="k">continue</span>                
        <span class="k">if</span> <span class="n">day</span> <span class="o">&gt;</span> <span class="n">TRAIN_DATE</span><span class="p">:</span>
            <span class="k">continue</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key_count_sum</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">day</span><span class="p">):</span>
            <span class="n">key_count_sum</span><span class="p">[</span><span class="n">day</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                
        <span class="n">key_count_sum</span><span class="p">[</span><span class="n">day</span><span class="p">]</span><span class="o">+=</span><span class="n">hour_uv</span>
        
        <span class="k">if</span> <span class="n">parse_date</span><span class="o">.</span><span class="n">hour</span> <span class="o">==</span> <span class="n">hour</span><span class="p">:</span>
            <span class="n">day_ct</span> <span class="o">=</span> <span class="n">daily_uv_dict</span><span class="p">[</span><span class="n">day</span><span class="p">]</span>
            <span class="n">x_list1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key_count_sum</span><span class="p">[</span><span class="n">day</span><span class="p">])</span>
            <span class="n">x_list2</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">hour_uv</span><span class="p">,</span><span class="n">key_count_sum</span><span class="p">[</span><span class="n">day</span><span class="p">]])</span>
            <span class="n">y_list2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">day_ct</span><span class="p">)</span>
            <span class="n">y_list1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">day_ct</span><span class="p">)</span>

    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_list1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    
    <span class="n">model</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y_list1</span><span class="p">)</span>

    <span class="n">hour_model_dict</span><span class="p">[</span><span class="n">hour</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span>

    <span class="n">g_model</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">g_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_list2</span><span class="p">),</span><span class="n">y_list2</span><span class="p">)</span>
    <span class="n">hour_model_dict2</span><span class="p">[</span><span class="n">hour</span><span class="p">]</span> <span class="o">=</span> <span class="n">g_model</span>
    <span class="k">if</span> <span class="n">hour</span><span class="o">%</span><span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;model learn&quot;</span><span class="p">,</span><span class="n">hour</span><span class="p">,</span><span class="s">&quot;hour&quot;</span></code></pre></div>

<h2 id="section-7">모델 사용</h2>

<ul>
  <li>만들어진 모델을 이용하여 실제 그날 그날의 UV 를 예측 해봅니다.</li>
  <li>예측한 일 UV 와 실제 일 UV 를 비교해서 어느정도 오차로 예측했는지를 봅니다.</li>
  <li>TRAIN_DATE 이후의 학습데이터로 사용하지 않은 데이터로 테스트를 해봅니다.</li>
</ul>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">diff1_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">diff2_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">hour</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">24</span><span class="p">):</span>
    <span class="n">x_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">y_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">x_list2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">y_list2</span> <span class="o">=</span> <span class="p">[]</span>    
    <span class="n">key_count_sum</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">hour_uv_result</span><span class="p">[</span><span class="s">u&#39;aggregations&#39;</span><span class="p">][</span><span class="s">&#39;2&#39;</span><span class="p">][</span><span class="s">u&#39;buckets&#39;</span><span class="p">]:</span>
        <span class="n">parse_date</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">each</span><span class="p">[</span><span class="s">u&#39;key_as_string&#39;</span><span class="p">])</span>
        <span class="n">day</span> <span class="o">=</span> <span class="n">parse_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s">&quot;</span><span class="p">)</span>   
        <span class="n">hour_uv</span> <span class="o">=</span> <span class="n">each</span><span class="p">[</span><span class="s">&#39;1&#39;</span><span class="p">][</span><span class="s">&#39;value&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">daily_uv_dict</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">day</span><span class="p">):</span>
            
            <span class="k">continue</span>        
        <span class="k">if</span> <span class="n">day</span> <span class="o">&lt;=</span> <span class="n">TRAIN_DATE</span><span class="p">:</span>
            <span class="k">continue</span>            
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key_count_sum</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">day</span><span class="p">):</span>
            <span class="n">key_count_sum</span><span class="p">[</span><span class="n">day</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="n">key_count_sum</span><span class="p">[</span><span class="n">day</span><span class="p">]</span><span class="o">+=</span><span class="n">hour_uv</span>
        
        <span class="k">if</span> <span class="n">parse_date</span><span class="o">.</span><span class="n">hour</span> <span class="o">==</span> <span class="n">hour</span><span class="p">:</span>

            <span class="n">day_ct</span> <span class="o">=</span> <span class="n">daily_uv_dict</span><span class="p">[</span><span class="n">day</span><span class="p">]</span>

            
            <span class="n">pred1</span> <span class="o">=</span> <span class="n">hour_model_dict</span><span class="p">[</span><span class="n">hour</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">key_count_sum</span><span class="p">[</span><span class="n">day</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">pred2</span> <span class="o">=</span> <span class="n">hour_model_dict2</span><span class="p">[</span><span class="n">hour</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">([</span><span class="n">hour_uv</span><span class="p">,</span><span class="n">key_count_sum</span><span class="p">[</span><span class="n">day</span><span class="p">]])</span>
            <span class="n">diff1_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="n">day_ct</span><span class="o">-</span><span class="n">pred1</span><span class="p">))))</span>
            <span class="n">diff2_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="n">day_ct</span><span class="o">-</span><span class="n">pred2</span><span class="p">))))</span>
        
<span class="k">print</span> <span class="s">&quot;diff1:&quot;</span><span class="p">,</span><span class="nb">sum</span><span class="p">(</span><span class="n">diff1_list</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">diff1_list</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&quot;diff2:&quot;</span><span class="p">,</span><span class="nb">sum</span><span class="p">(</span><span class="n">diff2_list</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">diff2_list</span><span class="p">)</span></code></pre></div>

<h1 id="section-8">정리하며</h1>
<ul>
  <li>이상으로 Regression 모델을 활용한 간단한 UV 예측 모델을 만들어 보았습니다.</li>
  <li>실제로 똑같이 따라하면 정확히 나오는 데이터 Source 까지 포함된 Ipython Notebook 을 올리고 싶은 마음도 굴뚝 같지만 UV 가 내부 데이터라 외부에 공개할 수 없어서 데이터 소스는 http://localhost:9200 로 해놓은 점은 양해 부탁 드립니다.</li>
  <li>위 코드는 참고만 하시고, 개념을 이해한 후에 개별로 적용을 하면서 익혀 나가시면 될것 같습니다.</li>
  <li><a href="https://www.dropbox.com/s/ubtjfbd39xo6ski/UV_regression.ipynb?dl=0">UV Regression Ipython Notebook</a></li>
  <li>그리고 저희 개발팀과 함께하실 서버 개발자 및 안드로이드 개발자를 모십니다. 많이들 지원해주세요~ (recruit@buzzni.com)</li>
  <li>그럼 모두들 즐코(즐거운 코딩) 하세요~</li>
</ul>


        </article>
    </div>
</div>



            </div>
        </div>

        <footer>

    <div class="container">

        <div class="copyright">
            &copy; <a href="http://www.buzzni.com/" target="_blank">Buzzni Inc</a>. All rights reserved. Powered by <a href="https://pages.github.com" target="_blank">GitHub Pages</a>.
        </div>

    </div><!-- end .container -->

</footer>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>


    </body>
</html>
